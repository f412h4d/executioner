cmake_minimum_required(VERSION 3.25)
project(executioner)

set(CMAKE_CXX_STANDARD 23)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# Prefer static libraries
set(BUILD_SHARED_LIBS OFF)
set(CMAKE_CXX_FLAGS "-static-libstdc++ -static-libgcc -static")

# Include directories
include_directories(
    modules/News/headers
    modules/Utils/headers
    modules/Margin/headers
    modules/Order/headers
    modules/Logger/headers
    modules/TradeSignal/headers
    modules/TradeSignal/models
    modules/Order/models
    modules/Order/models/APIParams
    modules/Order/models/OrderInput
    modules/Order/models/TriggerOrderInput
    modules/TimedEventQueue/headers
)

# Source files
set(SOURCES
    main.cpp
    modules/News/src/news.cpp
    modules/Utils/src/utils.cpp
    modules/Margin/src/margin.cpp
    modules/TradeSignal/src/trade_signal.cpp
    modules/Order/models/APIParams/APIParams.cpp
    modules/Order/models/OrderInput/OrderInput.cpp
    modules/Order/models/TriggerOrderInput/TriggerOrderInput.cpp
    modules/Order/src/OrderService.cpp
)

# Add executable
add_executable(executioner ${SOURCES})

# Fetch and build CPR as a static library
include(FetchContent)
FetchContent_Declare(
    cpr
    GIT_REPOSITORY https://github.com/libcpr/cpr.git
    GIT_TAG 1.10.5
)
FetchContent_MakeAvailable(cpr)
target_link_libraries(executioner PRIVATE cpr::cpr)

# Fetch and build nlohmann_json as a static library
FetchContent_Declare(
    json
    GIT_REPOSITORY https://github.com/nlohmann/json.git
    GIT_TAG v3.11.3
)
FetchContent_MakeAvailable(json)
target_link_libraries(executioner PRIVATE nlohmann_json::nlohmann_json)

FetchContent_Declare(
    fmt
    GIT_REPOSITORY https://github.com/fmtlib/fmt.git
    GIT_TAG 9.1.0  # Use a specific version compatible with your project
)
FetchContent_MakeAvailable(fmt)
target_link_libraries(executioner PRIVATE fmt::fmt)

FetchContent_Declare(
    spdlog
    GIT_REPOSITORY https://github.com/gabime/spdlog.git
    GIT_TAG v1.11.0  # Specify the version you need
)
FetchContent_MakeAvailable(spdlog)
target_link_libraries(executioner PRIVATE spdlog::spdlog)

# Find and link OpenSSL as a static library
find_package(OpenSSL REQUIRED)
target_link_libraries(executioner PRIVATE OpenSSL::SSL OpenSSL::Crypto)

# Link the static zlib library
find_package(ZLIB REQUIRED)
target_link_libraries(executioner PRIVATE ZLIB::ZLIB)

# Include vcpkg toolchain
set(CMAKE_TOOLCHAIN_FILE "/home/amir_f/vcpkg/scripts/buildsystems/vcpkg.cmake")

# Add vcpkg installation path to CMAKE_PREFIX_PATH
set(CMAKE_PREFIX_PATH ${CMAKE_PREFIX_PATH} "/home/amir_f/vcpkg/installed/x64-linux/share")

# Find the Google Cloud Pub/Sub package
find_package(google_cloud_cpp_pubsub REQUIRED)
target_link_libraries(executioner PRIVATE google-cloud-cpp::pubsub)

# Add this line to link the uuid library
find_package(Threads REQUIRED)
target_link_libraries(executioner PRIVATE uuid Threads::Threads)

# Add Boost components
find_package(Boost REQUIRED COMPONENTS system thread chrono date_time regex context)
target_link_libraries(executioner PRIVATE Boost::system Boost::thread Boost::chrono Boost::date_time Boost::regex Boost::context)

# Find and link Boost.Asio and Boost.Beast for WebSocket and SSL
find_package(Boost REQUIRED COMPONENTS asio beast)
target_link_libraries(executioner PRIVATE Boost::asio Boost::beast)

find_package(unofficial-sodium CONFIG REQUIRED)
target_link_libraries(executioner PRIVATE unofficial-sodium::sodium)
